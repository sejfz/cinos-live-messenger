<!DOCTYPE html>
<html>
  <head>
      <link rel="stylesheet" type="text/css" href="cinos.css">
    <title>Cinos Messages</title>
  </head>
  <body>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>

    <!-- Instantiate PubNub -->

    <script type="text/javascript">
      var direct = ""
      var pubnubDemo = new PubNub({
        publishKey: "pub-c-9104e0f9-e5b5-4025-b6e9-b1f56ba02166",

        subscribeKey: "sub-c-dc91d102-6a77-11e9-a1d6-2a8c316da507"
      });

      // Publish a simple message to the “demo_tutorial” channel pubnub:
      function pub(val) {
        pubnubDemo.publish({
          message: val,
          channel: document.getElementById("heading").innerHTML
        });

      }

      // Subscribe to the demo_tutorial channel pubnub

      pubnubDemo.addListener({
        message: function(message) {
          var messp = document.createElement("p");
          var mess = document.createTextNode(message.message);
          messp.appendChild(mess)
          document.getElementById("messageContainer").appendChild(messp)
          document.getElementById("messageBox").value = ""
        }
      });
      function sub (channel) {
        pubnubDemo.unsubscribeAll();
      pubnubDemo.subscribe({
        channels: [channel]
      });
}
      window.addEventListener("deviceorientation", deviceOrientationListener, true);

      // Get event data
      function deviceOrientationListener(event) {
        var alpha = event.alpha; //z axis rotation [0,360)
        var beta = event.beta; //x axis rotation [-180, 180]
        var gamma = event.gamma; //y axis rotation [-90, 90]

        //Check if absolute values have been sent
        if (typeof event.webkitCompassHeading !== "undefined") {
          alpha = event.webkitCompassHeading; //for iOS devices
          var heading = alpha;
          var direction = ""
          document.getElementById("heading").innerHTML = heading.toFixed([0])
          if (heading > 45 && heading < 136) {
            direction = "east"
            sub(direction);
          }
          else if (heading > 315 && heading < 46){
            direction = "north"
            sub(direction);
          }
          else if (heading > 135 && heading < 226) {
            direction = "south"
            sub(direction);
          }
          else if (heading > 225 && heading < 316) {
            direction = "west"
            sub(direction);
          }
          document.getElementById("heading").innerHTML = direction;
          direct = direction
        } else {
          alert(
            "Your device is reporting relative alpha values, so this compass won't point north :("
          );
          var heading = 360 - alpha; //heading [0, 360)

          document.getElementById("heading").innerHTML = heading.toFixed([0]);

        }
        
      }
    </script>
    <h1>Cinos Messaging Service</h1>
    <div class="desc"><p>Point your device in one of the four cardinal directions - North, South, East or West - to get messages
    belonging to that directions channel.
    </p></div>
    <br>
    <h4>Current channel:</h4>
    <p id="heading"></p>
    <input id="messageBox" type="text" onchange="pub(this.value)"></input>
    <input type="submit"></input>
    <div id="messageContainer" >

    </div>
    
  </body>
</html>
